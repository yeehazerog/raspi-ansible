---
# file: jupyter/tasks/main.yml

# Causes an error if we try and which something that doesn't exist so use this
# as a workaround.
#- name: Check to see if jupyter is already installed.
#  command: "{{ jupyter }} --version"
#  ignore_errors: true
#  changed_when: false # read-only task
#  check_mode: no
#  register: jupyter_is_installed

- name: Install pyhton dev.
  apt: name={{ item }} state=present
  with_items:
    - python3-apt
    - python3-pycurl
    - python3-setuptools
    - python3-dev
  become: yes

- name: Install jupyter.
  command: "{{ python }} -m {{ pip }} install jupyter"
  become: yes

# $ jupyter --version
- name: Check to see if jupyter is installed at the correct version.
  shell: "{{ jupyter }} --version | awk '{print $2}'"
  register: jupyter_installed_version
  changed_when: false
  check_mode: no
  when: jupyter_version or (jupyter_version | lower) != "latest"

- name: Install required version of jupyter.
  command: "{{ python }} -m {{ pip }} install jupyter=={{ jupyter_version }}"
  become: yes
  when: jupyter_version and jupyter_installed_version.stdout != jupyter_version and (jupyter_version | lower) != "latest"

- name: Create notebooks directory.
  file: path={{ jupyter_datadir }} owner=pi group=pi state=directory
  become: yes
  notify: jupyter
#    file:
#      path: '/storage/docker/jupyter/notebooks'
#      mode: 0777
#      state: directory

#- name: Check if jupyter config exists.
#    stat: path={{ jupyter_config_filename }}
#    register: stat_result_jupyter_config_file

- name: Create Jupyter profile.
  command: jupyter notebook --generate-config -y
  args:
    creates: '{{ jupyter_config_filename }}'
#  when stat_result_jupyter_config_file.stat.exists == False

- name: Apply Jupyter config
  template:
    src: jupyter_notebook_config.py.j2
    dest: '{{ jupyter_config_filename }}'
    mode: 0644
    force: yes

# Causes currently an error -> jupyter needs to be started manually
#- name: Start application
#  service: name=jupyter state=started

#- name: Start and enable jupyter
#    systemd:
#      name: jupyter
#      enabled: yes
#      state: started
